# 어디 갈래 — 인터랙션 플로우 (v2: 나침반 탭 방식)

> OLD: 이름 입력 -> 리빌 애니메이션 -> 결과
> NEW: 나침반 탭 -> 나린 비행 -> 나침반 회전 -> 방위 착지 -> 결과 펼침

## 마스코트: 나린(羅鱗)

나경수(나침반 나무)에서 태어난 하얀 신조(divine bird). 나린이 유일한 마스코트이며, 5방위 신수는 나린이 안내하는 대상이다.

- **가슴 나침반 문양**: 나침반 SVG와 동기화 — 나침반이 회전하면 가슴 문양도 같이 빛남
- **관모(冠毛) 5개**: 머리 위 왕관 깃털 5개, 각각 동/서/남/북/중 방위 대응. 활성 방위의 깃털만 glow
- **4 포즈**: main (나침반 위 앉기), thinking (갸웃), pointing (가리킴), flying (비행)
- **말투**: ~래요, ~거든래요 (나침반이 전하는 말을 전달하는 느낌)

---

## 1. 핵심 인터랙션 루프

### 1-1. 앱 진입 (홈 화면)

사용자가 앱을 열면 다음이 보인다:

1. **나린**이 나침반 위에 앉아 있다 (main 포즈, float 애니메이션, 가슴 나침반 문양 dim 상태)
2. **나침반(CompassRose SVG)**이 중앙에 크게 배치 — 5방위 모두 dim 상태 (opacity 0.3)
3. 나침반 아래에 **"탭해서 돌려봐!"** CTA 텍스트가 pulse 애니메이션으로 깜빡임
4. 화면 최상단에 앱 타이틀 "어디 갈래" + 나린의 인사말 (~래요 말투)
5. 하단에 **여행 기록** 영역 (이전 스핀 히스토리, 최대 7개)

> 이름 입력 필드는 완전히 제거. 나침반 자체가 CTA이자 인터랙션의 시작점.

### 1-2. 탭 -> 스핀 (인터랙션 트리거)

사용자가 나침반을 탭하면:

1. **탭 즉시**: 햅틱 피드백 (`softMedium`) + 나침반에 ripple 이펙트
2. **나린이 날아오른다**: 나침반 위에서 원형으로 비행 시작 (flying 포즈, Remotion 시퀀스)
3. **나침반 회전 시작**: 나린의 비행 궤적을 따라 나침반 바늘이 회전 + 나린 가슴 문양도 동기 발광
4. CTA 텍스트가 "나린이 길을 찾고 있어래요..." 로 전환

### 1-3. 스핀 애니메이션 (기대감 구간)

- 나침반이 빠르게 3바퀴 회전 -> 감속 -> 목표 방위에 정지
- 나린이 비행하며 깃털 파티클 흩날림 (관모 5개 중 활성 방위 깃털이 점점 밝아짐)
- 화면 배경에 해당 방위 색상이 은은하게 물듦
- 나침반 정지 시 — 활성 방위 glow + scale 1.3, 비활성 방위 fade

### 1-4. 결과 확인

나침반 정지 후:

1. **나린이 활성 방위 위에 착지** (main 포즈로 전환, 활성 관모 깃털만 glow)
2. **신수 도장(stamp seal)이 찍힌다** (stampPress 애니메이션)
3. 나침반 아래로 **결과 카드가 두루마리처럼 펼쳐진다** (scrollUnfurl)
4. 순서: 도장 -> 여행 시나리오 -> 국내 추천 -> 해외 추천 -> 나린 말풍선 팁
5. 사용자는 자유롭게 스크롤하며 결과 탐색

### 1-5. 결과 이후 행동

| 행동 | 설명 |
|------|------|
| 스크롤 탐색 | 결과 카드를 위아래로 스크롤 |
| 프리미엄 열기 | 숨은 명소 / 내일의 여행지 (광고 게이트) |
| 다시 돌리기 | 상단 나침반 재탭 -> 다시 스핀 (같은 날 = 같은 결과) |
| 여행 기록 확인 | 하단에서 과거 스핀 결과 리스트 확인 |

---

## 2. 반복 사용 설계

### 2-1. 일별 로테이션 메커니즘

**핵심 원리: "오늘의 여행지"는 매일 바뀐다**

| 요소 | 변경 주기 | 설명 |
|------|----------|------|
| 수호 신수 | 매일 | 오늘의 방위가 달라짐 (동->서->남->북->중 순환이 아닌, 해시 기반 변동) |
| 여행지 조합 | 매일 | 국내+해외 추천지가 달라짐 |
| 시나리오 텍스트 | 매일 | 두루마리에 표시되는 여행 서사가 달라짐 |
| 나린의 인사말 | 매일 | 시간대별(아침/낮/저녁) 다른 인사 (~래요 말투) |
| 숨은 명소 | 매일 | 프리미엄 콘텐츠도 매일 갱신 |

> 사용자가 내일 다시 열면 나침반은 완전히 다른 방위를 가리키고, 다른 여행지를 추천한다.

### 2-2. 여행 기록 시스템 (Recent Searches 대체)

이름 기반 "최근 검색"을 **날짜 기반 "여행 기록"**으로 대체한다.

```
Storage Key: 'where-to-go-journal'

저장 데이터:
[
  {
    date: '2026-02-10',
    beastId: 'cheongryong',
    beastName: '청룡',
    direction: '동',
    domestic: '오대산 전나무숲',
    international: '인터라켄',
    timestamp: 1739145600000
  },
  {
    date: '2026-02-09',
    beastId: 'jujak',
    ...
  }
]
최대 30일치 보관
```

**여행 기록 UI:**
- 홈 화면 하단에 캘린더 스트립(가로 스크롤) 형태
- 각 날짜에 해당 신수의 한자 아이콘이 작게 표시
- 탭하면 해당 날의 결과를 다시 볼 수 있음
- 7일 연속 스핀 시 "주간 여행자" 칭호 (시각적 뱃지, 기능적 잠금해제 아님)

### 2-3. 컬렉션 시스템: 5방위 스탬프 수집

5가지 수호 신수를 모두 만나면 **도장판 완성**:

```
┌─────────────────────────────────┐
│  여행 도장판                      │
│                                  │
│  [龍]  [虎]  [雀]  [武]  [皇]    │
│   ✓     ✓    ○    ✓     ○      │
│                                  │
│  3/5 수호신수를 만났어!           │
│  남은 수호신수를 만나러 가봐~     │
└─────────────────────────────────┘
```

- 매일 스핀할 때마다 해당 날의 신수가 도장판에 찍힘
- 5/5 완성 시 특별 메시지 + 나린 축하 애니메이션 (관모 5개 전부 glow)
- 리셋 주기: 월간 (매월 1일 초기화) -> 매달 다시 모을 수 있는 리텐션 루프

### 2-4. 푸시 알림 훅

| 시간 | 메시지 예시 |
|------|-----------|
| 매일 오전 9시 | "오늘의 여행지가 바뀌었어요! 어디로 가볼까?" |
| 3일 미방문 시 | "나린이 기다리고 있어래요... 오늘의 여행지를 확인해볼래요?" |
| 도장판 4/5 달성 | "마지막 수호신수 1개만 남았어요! 오늘 만날 수 있을지도?" |
| 월초 리셋 | "2월 도장판이 새로 열렸어요! 첫 여행지를 확인해봐~" |

---

## 3. 결과 결정 알고리즘

### 3-1. 설계 목표

| 요구사항 | 구현 |
|---------|------|
| 같은 사람 + 같은 날 = 같은 결과 | deviceId + date를 seed로 사용 |
| 어제와 다른 결과 | 날짜가 달라지면 해시값이 달라짐 |
| 이름 입력 없이 동작 | deviceId가 이름을 대체 |
| 같은 날 여러 번 탭해도 동일 | date 기반이므로 스핀 횟수와 무관 |

### 3-2. 알고리즘 의사코드

```typescript
function calculateTravelByDevice(dateKey?: string): TravelResult {
  const date = dateKey ?? todayKey();

  // deviceId: 앱인토스 환경에서는 기기 고유 식별자
  // 브라우저에서는 localStorage에 저장된 UUID (최초 1회 생성)
  const deviceId = await getOrCreateDeviceId();

  // seed = deviceId + 날짜 -> 매일 다르지만, 같은 날 같은 기기 = 동일 결과
  const seed = `${deviceId}@${date}`;
  const hash1 = hashString(seed);
  const beastIndex = hash1 % 5;
  const beastId = BEAST_ORDER[beastIndex];
  const beast = GUARDIAN_BEASTS[beastId];

  const hash2 = hashString(`${seed}:variation`);
  const variation = hash2 % 6;

  const dataSet = TRAVEL_DATA.find(d => d.beastId === beastId && d.variation === variation);

  return { beast, dataSet, date };
}

// deviceId 관리
async function getOrCreateDeviceId(): Promise<string> {
  const key = 'where-to-go-device-id';
  let id = await storageGet(key);
  if (!id) {
    id = crypto.randomUUID(); // 또는 nanoid()
    await storageSet(key, id);
  }
  return id;
}
```

### 3-3. 결정론적 보장

- **해시 함수**: 기존 djb2 해시 유지 (동일 입력 = 동일 출력)
- **seed 구조**: `{deviceId}@{YYYY-MM-DD}` -> 날짜가 바뀌면 해시 전체가 변동
- **방위 배정**: `hash % 5` -> 5방위 중 하나
- **여행지 변형**: `hashString(seed + ':variation') % 6` -> 6가지 변형 중 하나
- **결과**: 총 5 x 6 = 30가지 조합이 날짜에 따라 순환

### 3-4. 이전 코드와의 차이

| 항목 | OLD (v1) | NEW (v2) |
|------|----------|----------|
| seed 입력 | `name` (사용자 입력) | `deviceId` (자동) |
| seed 포맷 | `{name}@{date}` | `{deviceId}@{date}` |
| TravelResult.name | 사용자 이름 | 제거 (또는 빈 문자열) |
| 동일 조건 동일 결과 | 같은 이름+같은 날 | 같은 기기+같은 날 |

---

## 4. 애니메이션 시퀀스 (Remotion 기준)

### 4-1. 전체 타임라인 (총 4200ms)

```
시간(ms)   0     300    600   1200   2400   3200   3600   4200
           |------|------|------|------|------|------|------|
Phase 1:   |IDLE  |
Phase 2:          |TAP→LAUNCH|
Phase 3:                 |....COMPASS SPINNING....|
Phase 4:                                         |LAND + GLOW|
Phase 5:                                                |UNFURL→|
```

### Phase 1: Idle 상태 (앱 진입 ~ 탭 전)

| 요소 | 동작 | 지속 |
|------|------|------|
| 나침반 | 정지, 모든 방위 dim (opacity 0.3) | 무한 대기 |
| 나린 | 나침반 위 main 포즈, float 상하 움직임 (translateY 0 -> -6px -> 0), 가슴 문양 dim, 관모 5개 dim | 3초 반복 |
| CTA 텍스트 | "탭해서 돌려봐!" pulse 애니메이션 (opacity 0.5 -> 1 -> 0.5) | 2초 반복 |
| 배경 | 기본 앱 배경색 | 정적 |

### Phase 2: 탭 -> 스핀 개시 (0ms ~ 600ms)

| 시간(ms) | 요소 | 동작 |
|----------|------|------|
| 0 | 나침반 | ripple 이펙트 (탭 지점에서 원형 확산, 300ms) |
| 0 | 햅틱 | `generateHapticFeedback({ type: 'softMedium' })` |
| 0~300 | 나린 | 날개를 펴며 나침반에서 이륙 (flying 포즈, scale 1 -> 0.8 -> 1.2, translateY 0 -> -40px), 가슴 문양 발광 시작 |
| 300~600 | 나린 | 나침반 주위 원형 궤도에 진입 (radius 120px, 공전 시작), 관모 5개 전부 은은하게 빛남 |
| 300 | CTA 텍스트 | "나린이 길을 찾고 있어래요..." 로 crossfade 전환 |
| 300 | 나침반 바늘 | 출현 (opacity 0 -> 1, scale 0 -> 1) |

### Phase 3: 나침반 회전 (600ms ~ 2400ms, 총 1800ms)

| 시간(ms) | 요소 | 동작 |
|----------|------|------|
| 600~1400 | 나침반 | 빠른 회전 (easeIn, 0 -> 1080deg = 3바퀴) |
| 600~1400 | 나린 | 공전 속도 빠름 (나침반 회전과 동기화, 가슴 문양 빠르게 회전 발광) |
| 600~1400 | 깃털 파티클 | 비행 궤적에서 작은 깃털 3~4개 흩날림 (fade + drift) |
| 1400~2200 | 나침반 | 감속 구간 (easeOut, 1080deg -> 목표 각도 + 1440deg) |
| 1400~2200 | 나린 | 공전 감속 (나침반과 동기화), 활성 방위 관모 깃털이 점점 밝아짐 |
| 2200~2400 | 나침반 | 미세 진동 후 정지 (overshoot -> settle, spring 이징) |
| 2400 | 햅틱 | `generateHapticFeedback({ type: 'rigid' })` |

**나침반 회전 이징 커브:**
```
Phase 3a (fast):  cubic-bezier(0.4, 0, 0.2, 1)   — 가속
Phase 3b (decel): cubic-bezier(0, 0, 0.2, 1)      — 감속
Phase 3c (settle): spring(1, 80, 10)               — 스프링 정지
```

**목표 각도 계산:**
```typescript
// 신수별 나침반 각도
const TARGET_ANGLES = {
  cheongryong: 90,   // 동
  baekho: 270,       // 서
  jujak: 180,        // 남
  hyeonmu: 0,        // 북 (= 360)
  hwangryong: 45,    // 중 (북동 사이, 특별 위치)
};

// 최종 회전 = 기본 3바퀴(1080) + 감속 1바퀴(360) + 목표 각도
const totalRotation = 1080 + 360 + TARGET_ANGLES[beastId];
```

### Phase 4: 착지 + 글로우 (2400ms ~ 3600ms)

| 시간(ms) | 요소 | 동작 |
|----------|------|------|
| 2400~2800 | 나린 | 공전 궤도에서 활성 방위 쪽으로 이동 + main 포즈 전환 + 활성 관모만 full glow (나머지 4개 dim) |
| 2400~2800 | 활성 방위 | glow 시작 (filter: blur(8px) + drop-shadow, 신수 색상) |
| 2400~2800 | 활성 방위 | scale 1 -> 1.3 + pulse 시작 |
| 2400~2800 | 비활성 방위 | opacity 0.3 -> 0.15 (더 어둡게) |
| 2800~3200 | 배경 | 신수 색상이 화면 가장자리에서 은은하게 물듦 (vignette) |
| 3200~3600 | 도장 | stampPress 등장 (scale 2 -> 0.9 -> 1.0 + rotate 5deg -> 0deg) |
| 3200 | 햅틱 | `generateHapticFeedback({ type: 'softMedium' })` |

### Phase 5: 결과 카드 펼침 (3600ms ~ 4200ms+)

| 시간(ms) | 요소 | 동작 |
|----------|------|------|
| 3600~3800 | 나침반 | sticky 전환 (상단 고정, 260px -> 180px 축소) |
| 3800~4000 | 두루마리 | scrollUnfurl (max-height 0 -> 400px, 0.6s) |
| 4000~4200 | 국내/해외 카드 | slideUp stagger (각 150ms 간격) |
| 4200~4400 | 나린 말풍선 | fadeIn (pointing 포즈, ~거든래요 말투) |
| 4400+ | 프리미엄 카드 | fadeIn (잠금 상태) |

> Phase 5 이후 사용자는 자유롭게 스크롤하며 결과를 탐색한다.
> 나침반은 sticky로 상단에 고정되어 스크롤해도 계속 보인다.

### 4-2. Remotion 구성

```
Composition: CompassSpinSequence
  FPS: 30
  Duration: 126 frames (4200ms)

  Series:
    - <NarinIdle />           frames 0~8     (Phase 1 -> 2 전환)
    - <NarinLaunch />         frames 9~18    (Phase 2: 이륙 + 가슴 문양 발광)
    - <CompassSpin />         frames 18~72   (Phase 3: 나침반+나린 동기 회전)
    - <NarinLanding />        frames 72~108  (Phase 4: 착지 + 관모 glow)
    - <ResultUnfurl />        frames 108~126 (Phase 5)
```

각 서브컴포넌트는 `useCurrentFrame()`과 `interpolate()`를 사용하여 프레임 단위로 정밀 제어.

---

## 5. 광고 통합 포인트

### 5-1. 무료 (핵심 기능)

| 기능 | 설명 |
|------|------|
| 나침반 스핀 | 매일 1회 탭으로 오늘의 여행지 확인 |
| 수호 신수 + 도장 | 어떤 신수가 수호하는지 확인 |
| 여행 시나리오 | 두루마리 1문장 통합 서술 |
| 국내 + 해외 추천지 | 각 1곳씩 추천 |
| 나린 팁 말풍선 | 여행 조언 (pointing 포즈, ~거든래요 말투) |
| 여행 기록 | 지난 30일 스핀 기록 열람 |
| 도장판 | 5방위 수집 현황 |

### 5-2. 프리미엄 (광고 게이트)

#### 프리미엄 1: 숨은 명소 추천

- **트리거**: 호기심 (기본 추천지 외에 "아는 사람만 아는 곳"에 대한 궁금증)
- **UI**: 잠금 카드 + 블러 처리 + AD 배지
- **고지 문구**: "광고 시청 후 열람할 수 있어요"
- **해금 후**: 숨은 명소 이름 + 설명 공개
- **예상 CTR**: ★★★★ (기본 결과를 본 후 추가 정보에 대한 호기심)

#### 프리미엄 2: 내일의 여행지 미리보기

- **트리거**: 호기심 + 손실회피 ("내일이 되면 바뀌는데, 미리 볼 수 있다면?")
- **UI**: "내일의 방위를 미리 엿볼까?" + 잠금 나침반 아이콘 + AD 배지
- **고지 문구**: "광고 시청 후 열람할 수 있어요"
- **해금 후**: 내일 날짜 기준으로 계산한 신수 + 여행지 프리뷰 (시나리오는 미제공)
- **예상 CTR**: ★★★★★ (시간 제한 콘텐츠에 대한 조기 접근)
- **구현**: `calculateTravelByDevice(tomorrowKey())` 호출

> "내일의 여행지 미리보기"는 기존 "이번 주 여행 운세"를 대체한다.
> 이름 입력이 없는 새 플로우에서 "주간 운세"보다 "내일 미리보기"가 더 자연스러운 가치 교환이다.

### 5-3. 광고 타이밍

```
사용자 행동 흐름:

  [앱 열기] -> [나침반 탭] -> [스핀 애니메이션] -> [결과 확인]
       |                                              |
       |                                              v
       |                                     [스크롤 탐색]
       |                                              |
       |                               +--------------+--------------+
       |                               |              |              |
       |                               v              v              v
       |                          [숨은 명소]   [내일 미리보기]  [다시 돌리기]
       |                          (AD 시청)     (AD 시청)       (같은 결과)
       |                               |              |
       |                               v              v
       |                          [명소 공개]   [내일 프리뷰]
       |
       (다음날 재방문)
```

핵심 기능(스핀 -> 결과)에는 절대 광고를 삽입하지 않는다.
광고는 결과 확인 이후, 사용자가 자발적으로 프리미엄 콘텐츠를 선택할 때만 노출된다.

---

## 6. 엣지 케이스

### 6-1. 같은 날 여러 번 스핀

**동작**: 동일한 결과가 나온다.

- seed가 `deviceId@date`이므로 같은 날 같은 기기 = 같은 해시 = 같은 결과
- 나침반 애니메이션은 매번 재생된다 (시각적 즐거움)
- 결과가 동일하다는 것을 사용자에게 알리지 않는다 (스핀 자체가 재미)
- 여행 기록에는 같은 날 데이터는 덮어쓰기 (중복 생성 안 함)

### 6-2. 오프라인 모드

**동작**: 정상 작동 (네트워크 불필요).

- 결과 계산: 로컬 해시 함수 + 로컬 데이터이므로 오프라인에서도 동작
- 여행 기록: localStorage/Storage 사용이므로 오프라인에서도 저장/조회 가능
- 광고: 오프라인 시 광고 로드 실패 -> AD 버튼 비활성화 (disabled + "네트워크 연결 필요" 텍스트)
- deviceId: 최초 생성 후 로컬 저장이므로 오프라인에서도 사용 가능

### 6-3. 최초 사용자 경험 (First Time User Experience)

**첫 방문 시 추가 요소:**

1. **웰컴 오버레이** (1회만 표시):
   - 나린이 등장하며 자기소개 (main 포즈, 가슴 문양 pulse)
   - "나는 나린이래요~ 나경수에서 태어난 길안내 새거든래요!"
   - "나침반을 탭하면 오늘의 여행지를 알려줄게래요~ 매일 바뀌니까 내일도 와줘래요!"
   - 하단에 "시작하기" 버튼 -> 오버레이 닫힘 -> 홈 화면

2. **첫 스핀 가이드**:
   - 나침반 주변에 손가락 탭 아이콘 힌트 (3초 후 자동 사라짐)
   - 첫 스핀 결과 하단에 "도장판을 모아봐! 5개 수호신수를 모두 만나봐~" 안내

3. **deviceId 생성**:
   - 첫 앱 실행 시 `crypto.randomUUID()`로 고유 ID 생성
   - Storage에 영구 저장
   - 사용자에게 노출하지 않음

### 6-4. 날짜 변경 시점 (자정)

- 자정(00:00)을 기준으로 "오늘"이 바뀜
- 앱이 열려 있는 상태에서 자정이 지나면:
  - 다음 스핀 시 새로운 날짜의 결과가 나옴
  - 이전 결과는 자동으로 여행 기록에 저장됨
  - 별도의 리프레시 없이 탭하면 자연스럽게 전환

### 6-5. 황룡(중앙) 방위 처리

- 황룡은 나침반의 중앙에 위치하므로 바늘이 "가리킬" 방위가 없음
- **처리**: 바늘이 나침반 중앙의 황룡 원을 가리키며, 나침반이 45도 각도에서 정지
- 중앙 원이 glow + pulse 애니메이션
- 결과 텍스트: "오늘은 방위를 넘어선 특별한 여행!" (중앙 = 특별/미식/보물 테마)

### 6-6. 도장판 월초 리셋

- 매월 1일 00:00에 도장판 초기화
- 이전 달 완성 여부는 별도 저장 (`where-to-go-stamp-history`)
- 완성 달에는 작은 별 표시 (예: "1월 ★ / 2월 수집 중...")
- 리셋 시 나린 안내: "새 도장판이 열렸거든래요! 이번 달도 5방위를 모아봐래요~"
